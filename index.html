<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>test</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="search-layer">
  <!-- новый ряд с кругом и строкой поиска -->
  <div class="search-row">
    <span class="search-badge" aria-hidden="true"></span>

    <label class="search">
      <span class="search-icon"></span>
      <input class="hidden-input m20" type="text" placeholder="Поиск в Москве" value="Поиск в Москве" readonly>
      <span class="filter-icon"></span>
    </label>
  </div>
  <div class="search-caption">
    <div class="h3">Кемпинг в Твери</div>
    <div class="s20">Снаряжение и маршруты</div>
    <div id="search-sentinel" aria-hidden="true"></div>
  </div>
  <div class="search-hero"></div>
</div>

<section class="tabs s20">
  <div class="tab-row first">
    <div class="tab goods">Товары</div>
    <div class="tab realty">Недвижи-<br>мость</div>
    <div class="tab travel">Путеше-<br>ствия</div>
  </div>
  <div class="tab-row second">
    <div class="tab auto">Авто</div>
    <div class="tab service">Услуги</div>
    <div class="tab job">Работа</div>
    <div class="tab all">Всё</div>
  </div>
</section>

<section class="promo">
  <div class="tag"><span class="tag__label">Реклама</span></div>
  <div class="img-right"></div>
  <div class="img-left"></div>
</section>

<section class="cards" id="cards"></section>

<!-- Плавающие CTA -->
<div class="float-cta m20">
  <button class="cta cta--ghost" type="button">Мои объявления</button>
  <button class="cta cta--primary" type="button">
    <span class="cta__icon_add" aria-hidden="true"></span>
  </button>
</div>

<footer class="tabbar" role="navigation" aria-label="Основная навигация">
  <button class="tabbar__btn home is-active" aria-label="Главная"></button>
  <button class="tabbar__btn favorites" aria-label="Избранное"></button>
  <button class="tabbar__btn wallet" aria-label="Кошелёк"></button>
  <button class="tabbar__btn messenger" aria-label="Чат"></button>
  <a href="assistant.html" class="tabbar__btn assistent" aria-label="Ассистент" role="button"></a>
</footer>

<script>
  document.querySelectorAll('.tab').forEach(function (tab) {
    tab.addEventListener('click', function () {
      document.querySelectorAll('.tab').forEach(function (item) {
        item.classList.remove('active');
      });
      this.classList.add('active');
    });
  });

  // (не ломает ничего, если на странице нет .card .heart)
  document.querySelectorAll('.card .heart').forEach(function (heart) {
    heart.addEventListener('click', function (event) {
      event.stopPropagation();
      heart.classList.toggle('saved');
      heart.textContent = heart.classList.contains('saved') ? '❤' : '♡';
    });
  });
</script>

<script>
(async function () {
  const mount = document.getElementById('cards');

  const HEART_OFF = './res/heart_snippet.svg';
  const HEART_ON  = './res/heart_snippet_full.svg';

  const el = (t, c, h) => {
    const n = document.createElement(t);
    if (c) n.className = c;
    if (h != null) n.innerHTML = h;
    return n;
  };

  /* === ЛЕНИВАЯ ПОДГРУЗКА СКРИПТА КОНФЕТТИ (вынесено во внешний файл) === */
  const _loadedScripts = new Map();
  function loadScriptOnce(url, doc){
    if (_loadedScripts.has(url)) return _loadedScripts.get(url);
    const p = new Promise((resolve, reject)=>{
      const s = doc.createElement('script');
      s.src = url; s.async = true; s.onload = ()=>resolve(); s.onerror = reject;
      doc.head.appendChild(s);
    });
    _loadedScripts.set(url, p);
    return p;
  }
  /* ===================================================================== */

  function attachSwipe(rail, dots){
    const container = rail.parentElement;
    const count = rail.children.length;
    if (count <= 1) return;

    let idx = 0, startX = 0, startY = 0, curX = 0;
    let dragging = false, baseX = 0;

    const width = () => container.clientWidth;

    const setIdx = (i, animate = true) => {
      idx = Math.max(0, Math.min(count - 1, i));
      const target = -idx * width();
      rail.style.transition = animate ? 'transform 320ms ease' : 'none';
      rail.style.transform  = `translateX(${target}px)`;
      baseX = target;
      if (dots) [...dots.children].forEach((d, k) => d.classList.toggle('active', k === idx));
    };

    const onStart = e => {
      if (e.type === 'mousedown' && e.button !== 0) return;
      dragging = true;
      rail.style.transition = 'none';
      const t = e.touches ? e.touches[0] : e;
      startX = t.clientX; startY = t.clientY; curX = startX;
      container.classList.add('grabbing');
    };

    const onMove = e => {
      if (!dragging) return;
      const t = e.touches ? e.touches[0] : e;
      curX = t.clientX;
      const dx = curX - startX;
      const dy = t.clientY - startY;
      if (Math.abs(dx) > Math.abs(dy)) e.preventDefault();
      rail.style.transform = `translateX(${baseX + dx}px)`;
    };

    const onEnd = () => {
      if (!dragging) return;
      dragging = false;
      container.classList.remove('grabbing');
      const dx = curX - startX;
      const th = Math.max(40, width() * 0.12);
      if (dx <= -th) setIdx(idx + 1);
      else if (dx >= th) setIdx(idx - 1);
      else setIdx(idx);
    };

    container.addEventListener('touchstart', onStart, { passive: true  });
    container.addEventListener('touchmove',  onMove,  { passive: false });
    container.addEventListener('touchend',   onEnd);
    container.addEventListener('mousedown',  onStart);
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup',   onEnd);

    const ro = new ResizeObserver(() => setIdx(idx, false));
    ro.observe(container);
    setIdx(0, false);
  }

  const res = await fetch('./cards.json', { cache: 'no-store' });
  if (!res.ok) throw new Error('Не удалось загрузить cards.json: ' + res.status);
  const items = await res.json();

  const isGradientOrColor = s => /^(?:linear|radial|conic)-gradient\(|^#|^rgb[a]?\(/i.test(s);
  const isVideo = s => /\.(mp4|webm|ogg)$/i.test(s);
  const resolveSrc = (src) => {
    const isAbs = /^(https?:|data:|\/|\.\/|\.\.\/)/i.test(src);
    return encodeURI(isAbs ? src : './' + src);
  };

  items.forEach(item => {
    const card = el('article', 'card');

    // --- галерея ---
    const pics = Array.isArray(item.images) && item.images.length
      ? item.images.slice()
      : (item.image ? [item.image] : []);

    const imgHost = el('div', 'image-host');
    const imgWrap = el('div', 'image');
    const rail    = el('div', 'image-rail');

    imgWrap.appendChild(rail);
    imgHost.appendChild(imgWrap);

    pics.forEach(src => {
      const slide = el('div','image-slide');

      if (isGradientOrColor(src)) {
        slide.style.background = src;
      } else if (isVideo(src)) {
        const v = document.createElement('video');
        v.src = resolveSrc(src);
        v.muted = true; v.loop = true; v.autoplay = true; v.playsInline = true;
        v.preload = 'metadata'; v.controls = false;
        slide.appendChild(v);
      } else {
        const img = new Image();
        img.loading = 'lazy';
        img.decoding = 'async';
        img.src = resolveSrc(src);
        img.alt = item.title || '';
        img.style.width  = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.objectPosition = 'center';
        img.onerror = () => {
          console.warn('Не удалось загрузить изображение:', img.src);
          slide.style.background = '#e8edf6';
        };
        slide.appendChild(img);
      }

      rail.appendChild(slide);
    });

    let dots = null;
    if (pics.length > 1) {
      dots = el('div','image-dots');
      for (let i = 0; i < pics.length; i++) dots.appendChild(el('span','image-dot'));
      imgHost.appendChild(dots);
    }

    // простой бейдж (если используешь расширенную систему бейджей — можешь заменить)
    if (item.badge) imgHost.appendChild(makeRibbon(item.badge, item.badgeColor));

    card.appendChild(imgHost);

    if (pics.length > 1) attachSwipe(rail, dots);
    else imgWrap.classList.add('image--static');

    // --- контент ---
    const content = el('div','card-content');
    const titleRow = el('div','title-row');
    titleRow.appendChild(el('div','card-title m20', item.title));

    // избранное (SVG)
    const heart = el('button','heart');
    heart.type = 'button';
    heart.setAttribute('aria-pressed','false');
    heart.setAttribute('aria-label','Добавить в избранное');

    const heartIcon = new Image();
    heartIcon.src = HEART_OFF;
    heartIcon.alt = '';
    heartIcon.width = 18; heartIcon.height = 18;
    heart.appendChild(heartIcon);

    heart.addEventListener('click', async () => {
      const saved = heart.classList.toggle('saved');
      heart.setAttribute('aria-pressed', saved ? 'true' : 'false');
      heart.setAttribute('aria-label', saved ? 'Убрать из избранного' : 'Добавить в избранное');
      heartIcon.src = saved ? HEART_ON : HEART_OFF;

      // ЕДИНЫЕ конфетти on/off
      try {
        await loadScriptOnce('./particles-burst.js', document);
        if (window.ParticlesBurst?.burst) {
          heart.classList.add('animating');
          window.ParticlesBurst.burst(
            heart,
            saved ? window.ParticlesBurst.presets.heartOn
                  : window.ParticlesBurst.presets.heartOff
          );
          setTimeout(() => heart.classList.remove('animating'), 320);
        }
      } catch (e) {
        console.debug('Particles module not loaded:', e);
      }
    });



    titleRow.appendChild(heart);
    content.appendChild(titleRow);

    // цена
    const priceRow = el('div','price-row');
    priceRow.appendChild(el('div','price h4', item.price));

    const oldLine = el('div','old-line');
    if (item.oldPrice) oldLine.appendChild(el('div','price-old s10', item.oldPrice));
    if (item.discount) oldLine.appendChild(el('div','discount s10', item.discount));
    if (oldLine.childNodes.length) priceRow.appendChild(oldLine);

    content.appendChild(priceRow);

    if (item.subtitle) content.appendChild(el('div','s10 card-subtitle', item.subtitle));
    if (item.meta)     content.appendChild(el('div','s10 card-meta', item.meta));

    card.appendChild(content);
    mount.appendChild(card);
  });
})();
</script>

<script>
/* бейдж из исходного кода */
function makeRibbon(text, color = '#30c977') {
  const wrap = document.createElement('span');
  wrap.className = 'ribbon';
  wrap.style.setProperty('--ribbon', color);

  const left = document.createElement('span');
  left.className = 'ribbon__cap ribbon__cap--left';
  left.setAttribute('aria-hidden', 'true');

  const body = document.createElement('span');
  body.className = 'ribbon__body s10';
  body.textContent = text;

  const right = document.createElement('span');
  right.className = 'ribbon__cap ribbon__cap--right';
  right.setAttribute('aria-hidden', 'true');

  wrap.append(left, body, right);
  return wrap;
}
</script>

<script>
document.querySelectorAll('.tabbar__btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tabbar__btn').forEach(b=>{
      b.classList.remove('is-active');
      b.setAttribute('aria-current','false');
      b.setAttribute('aria-pressed','false');
    });
    btn.classList.add('is-active');
    btn.setAttribute('aria-current','page');
    btn.setAttribute('aria-pressed','true');
  });
});
</script>

<script>
(function(){
  const floater = document.querySelector('.float-cta');
  if (!floater) return;

  let lastY = window.scrollY;
  let hidden = false;
  let raf = null;

  // Насколько «близко к низу» считаем, что уже низ (px)
  const BOTTOM_EPS = 24;
  // Малый порог для "самого верха", чтобы не дёргать у шапки
  const TOP_EPS = 8;

  function atBottom() {
    const doc = document.documentElement;
    // высота видимой области + скролл ≥ вся высота документа - эпсилон
    return (window.innerHeight + window.scrollY) >= (doc.scrollHeight - BOTTOM_EPS);
  }

  function atTop() {
    return window.scrollY < TOP_EPS;
  }

  const onScroll = () => {
    const y = window.scrollY;
    const goingDown = y > lastY;
    lastY = y;

    // ЛОГИКА:
    // - если крутим вниз и не у самого верха → скрываем
    // - НО если у самого низа → всегда показываем
    // - если крутим вверх → показываем
    let shouldHide = goingDown && !atTop();

    if (atBottom()) shouldHide = false; // у низа всегда показаны

    if (shouldHide !== hidden) {
      hidden = shouldHide;
      floater.classList.toggle('is-away', hidden);
    }
  };

  // rAF-троттлинг скролла
  window.addEventListener('scroll', () => {
    if (raf) return;
    raf = requestAnimationFrame(() => { raf = null; onScroll(); });
  }, {passive:true});

  window.addEventListener('resize', onScroll);

  // первичная инициализация
  onScroll();
})();
</script>


<script>
(() => {
  const originalRow = document.querySelector('.search-row');
  const sentinel    = document.getElementById('search-sentinel');
  if (!originalRow || !sentinel) return;

  const sticky = document.createElement('div');
  sticky.className = 'search-sticky';
  sticky.setAttribute('aria-hidden', 'true');

  const stickyRow    = document.createElement('div');
  stickyRow.className = 'search-row';

  const stickyBadge  = originalRow.querySelector('.search-badge')?.cloneNode(true);
  const stickySearch = originalRow.querySelector('.search')?.cloneNode(true);

  if (stickyBadge)  stickyRow.appendChild(stickyBadge);
  if (stickySearch) stickyRow.appendChild(stickySearch);

  sticky.appendChild(stickyRow);
  document.body.appendChild(sticky);

  const io = new IntersectionObserver(([entry]) => {
    sticky.classList.toggle('is-on', !entry.isIntersecting);
  }, { threshold: 0 });
  io.observe(sentinel);
})();
</script>

</body>
</html>
