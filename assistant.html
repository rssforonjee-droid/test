<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ß–∞—Ç</title>

  <!-- –°—Ç–∏–ª–∏ -->
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="assistant.css">

  <!-- –ù–µ–±–æ–ª—å—à–∏–µ —É–ª—É—á—à–∞—Ç–µ–ª–∏ -->
  <style>
    /* –∞–Ω—Ç–∏-–ø—Ä—ã–∂–æ–∫ —Å–∫—Ä–æ–ª–ª–∞ —É –Ω–∏–∑–∞ */
    .chat{ overflow-anchor:none; }
    .chat .anchor{ overflow-anchor:auto; height:1px; }
  </style>
</head>
<body>

<div class="app">
  <!-- –®–∞–ø–∫–∞ -->
  <div class="topbar">
    <a href="index.html" class="btn close-btn" aria-label="–∑–∞–∫—Ä—ã—Ç—å" role="button"></a>
    <div href="" class="btn new-chat-btn" aria-label="–Ω–æ–≤—ã–π —á–∞—Ç" role="button"></div>
    <div href="" class="btn last-chat-btn" aria-label="—Å—Ç–∞—Ä—ã–µ —á–∞—Ç—ã" role="button"></div>
  </div>

  <!-- –õ–µ–Ω—Ç–∞ —á–∞—Ç–∞: –∏–Ω—Ç—Ä–æ —á–∞—Å—Ç—å –ª–µ–Ω—Ç—ã -->
  <section id="chat" class="chat">
    <div class="intro">
      <div class="date xs">–°–µ–≥–æ–¥–Ω—è</div>
      <h3>–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –ò–ò-–≥–∏–¥ ‚ú®</h3>
      <p class="help-assist m20">
        –î–∞–≤–∞–π—Ç–µ –ø–æ–º–æ–≥—É –≤–∞–º —Å –ª—é–±—ã–º –¥–µ–ª–æ–º: –æ—Ç–≤–µ—á—É –Ω–∞&nbsp;–≤–æ–ø—Ä–æ—Å—ã
        –∏&nbsp;–Ω–∞–π–¥—É –≤—ã–≥–æ–¥–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ù–∞—á–Ω—ë–º?
      </p>
    </div>

    <!-- —Å—é–¥–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è .msg -->
    <div class="anchor"></div>
  </section>
</div>

<!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É –Ω–∏–∑–∞ ¬´–∫–æ–º–ø–æ–∑–µ—Ä¬ª -->
<div class="composer">
  <div class="msg-input">
    <div class="msg-input__box">
      <textarea
        class="msg-input__field"
        placeholder="–ù–∞–π–¥–∏ –º–æ—â–Ω—ã–π –Ω–æ—É—Ç–±—É–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã –∏ –∏–≥—Ä"
      ></textarea>
      <button class="msg-input__send" type="button" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å"></button>
    </div>
  </div>
</div>

<script src="assistant-cards.js"></script>

<script>
/* =========================
   assistant-core.js (—Å –ø—Ä–∞–≤–∫–∞–º–∏)
========================= */
(() => {
  /* =========================
     –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã/–Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  ========================== */
  const CARDS_CSS_URL    = 'assist-cards.css';
  const ANSWER_DATA_URL  = 'answer_data.json';
  const FALLBACK_TXT     = '–ì–æ—Ç–æ–≤–æ! –í–æ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.';
  const HEART_OFF        = './res/heart_snippet.svg';
  const HEART_ON         = './res/heart_snippet_full.svg';

  /* =========================
     –£–∑–ª—ã
  ========================== */
  const chat     = document.getElementById('chat');
  const ta       = document.querySelector('.msg-input__field');
  const send     = document.querySelector('.msg-input__send');
  const composer = document.querySelector('.composer');
  if (!chat || !ta || !send || !composer) return;

  /* =========================
     –§–ª–∞–≥ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏
  ========================== */
  let isBusy = false;
  function setBusy(v){
    isBusy = v;
    send.disabled = v;
    send.setAttribute('aria-disabled', v ? 'true' : 'false');
  }

  /* =========================
     Batch-—Å–∫—Ä–æ–ª–ª (–≥–∞—Å–∏–º ¬´–ø—Ä—ã–∂–æ–∫¬ª –∏–Ω—Ç—Ä–æ)
  ========================== */
  let scrollBatchDepth = 0;
  function beginScrollBatch(el){
    if (scrollBatchDepth++ === 0) {
      el.dataset.prevScrollBehavior = getComputedStyle(el).scrollBehavior || '';
      el.style.scrollBehavior = 'auto';
    }
  }
  function endScrollBatch(el){
    if (--scrollBatchDepth === 0) {
      el.style.scrollBehavior = el.dataset.prevScrollBehavior || '';
      delete el.dataset.prevScrollBehavior;
    }
  }
  function isNearBottom(el, threshold = 48){
    return el.scrollHeight - el.scrollTop - el.clientHeight < threshold;
  }
  function scrollToBottomSafe(){
    // –∂–¥—ë–º –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É –∏ –ø–µ—Ä–µ—Ä–∞—Å—á—ë—Ç offset'a –∫–æ–º–ø–æ–∑–µ—Ä–∞
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        chat.scrollTop = chat.scrollHeight;
      });
    });
  }
  function scrollToNode(node){
    if (!node) return;
    // —Å–∫—Ä–æ–ª–ª–∏–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ¬´—É –Ω–∏–∑–∞¬ª
    if (isNearBottom(chat)) {
      node.scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'nearest' });
    }
  }

  /* =========================
     –ú—å—é—Ç/–∞–Ω–º—å—é—Ç –∫–æ–º–ø–æ–∑–µ—Ä–∞
  ========================== */
  function muteComposer(){
    ta.classList.add('is-muted');
    ta.blur();
    setTimeout(() => { if (typeof syncComposerOffset === 'function') syncComposerOffset(); }, 50);
  }
  function unmuteComposer(){
    ta.classList.remove('is-muted');
  }

  /* =========================
     1vh + –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (iOS/–º–æ–±–∏–ª–∫–∏)
  ========================== */
  function setVh(){
    const vv = window.visualViewport;
    const px = vv ? vv.height * 0.01 : window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${px}px`);
  }
  setVh();
  window.addEventListener('resize', setVh);
  if (window.visualViewport){
    visualViewport.addEventListener('resize', setVh);
    visualViewport.addEventListener('scroll', setVh);
  }

  /* =========================
     –ü–æ–¥—ä—ë–º —Ç–æ–ª—å–∫–æ –∫–æ–º–ø–æ–∑–µ—Ä–∞
     (—Ñ–∏–∫—Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –±–µ–ª–æ–π —â–µ–ª–∏)
  ========================== */
  function syncComposerOffset(){
    if (!window.visualViewport) return;
    const vv = visualViewport;
    const overlap = Math.max(0, (window.innerHeight - vv.height - vv.offsetTop));

    // –ü–æ–¥–Ω–∏–º–∞–µ–º –¢–û–õ–¨–ö–û –∫–æ–º–ø–æ–∑–µ—Ä
    composer.style.transform = `translateY(${-overlap}px)`;

    // –†–µ–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–æ–º–ø–æ–∑–µ—Ä–∞ (—Å –ø–∞–¥–¥–∏–Ω–≥–∞–º–∏)
    const compH = composer.getBoundingClientRect().height;

    // –í–∞–∂–Ω–æ: –ø–∞–¥–¥–∏–Ω–≥ –ª–µ–Ω—Ç—ã = compH - overlap (–∞ –Ω–µ base + overlap)
    const newPadBottom = Math.max(12, compH - overlap);
    chat.style.paddingBottom = newPadBottom + 'px';
  }
  if (window.visualViewport){
    visualViewport.addEventListener('resize', syncComposerOffset);
    visualViewport.addEventListener('scroll',  syncComposerOffset);
    syncComposerOffset();
  }

  /* ======================================================
     iOS FIX: –õ–û–ö –°–ö–†–û–õ–õ–ê, —á—Ç–æ–±—ã –Ω–∞–≤–±–∞—Ä/–∏–Ω—Ç—Ä–æ –Ω–µ —É–µ–∑–∂–∞–ª–∏
  ====================================================== */
  const scrollLock = {
    enabled: false,
    chatY: 0,
    winX: 0,
    winY: 0,
  };

  function keepPositions(){
    window.scrollTo(scrollLock.winX, scrollLock.winY);
    chat.scrollTop = scrollLock.chatY;
  }

  function enableScrollLock(){
    if (scrollLock.enabled) return;
    scrollLock.enabled = true;
    scrollLock.chatY = chat.scrollTop;
    scrollLock.winX  = window.pageXOffset || 0;
    scrollLock.winY  = window.pageYOffset || 0;

    // –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π
    keepPositions();
    setTimeout(keepPositions, 0);
    setTimeout(keepPositions, 60);
  }

  function disableScrollLock(){
    if (!scrollLock.enabled) return;
    scrollLock.enabled = false;
  }

  if (window.visualViewport){
    const vvStick = () => { if (scrollLock.enabled) keepPositions(); };
    visualViewport.addEventListener('resize', vvStick, { passive: true });
    visualViewport.addEventListener('scroll',  vvStick, { passive: true });
  }

  /* =========================
     Autosize textarea (–¥–æ 106px)
  ========================== */
  function autosize(){
    ta.style.height = '24px';
    ta.style.height = Math.min(106, ta.scrollHeight) + 'px';
  }
  ['input','change'].forEach(e => ta.addEventListener(e, autosize));
  window.addEventListener('load', autosize);

  ta.addEventListener('focus', () => {
    enableScrollLock();
    unmuteComposer();
    syncComposerOffset();     // –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å–¥–≤–∏–≥
    scrollToBottomSafe();     // –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–∏–¥–∏–º—ã–º
  });

  ta.addEventListener('blur', () => {
    disableScrollLock();
  });

  /* =========================
     –ë–∞–∑–æ–≤—ã–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã DOM
  ========================== */
  function addMessage(role, content, {html=false, beforeNode=null, replaceNode=null} = {}){
    beginScrollBatch(chat);
    const el = document.createElement('div');
    el.className = `msg m20 ${role}`;
    if (html) el.innerHTML = content; else el.textContent = content;

    const anchor = chat.querySelector('.anchor');
    if (replaceNode) replaceNode.replaceWith(el);
    else if (beforeNode) chat.insertBefore(el, beforeNode);
    else chat.insertBefore(el, anchor);

    // –±–µ–∑–æ–ø–∞—Å–Ω–æ –∫ –Ω–∏–∑—É
    scrollToBottomSafe();
    endScrollBatch(chat);
    return el;
  }

  function showThinking(){
    beginScrollBatch(chat);
    const el  = document.createElement('div');
    el.className = 'typing';

    const vid = document.createElement('video');
    vid.autoplay = true; vid.loop = true; vid.muted = true; vid.playsInline = true; vid.preload = 'auto';

    const s1 = document.createElement('source'); s1.src = './res/anim_01.mp4';  s1.type = 'video/mp4';
    const s2 = document.createElement('source'); s2.src = './anim/anim_01-2.webm'; s2.type = 'video/webm';
    vid.appendChild(s1); vid.appendChild(s2);

    const fallback = document.createElement('span');
    fallback.innerHTML = '<i></i><i></i><i></i>';
    fallback.style.display = 'none';
    fallback.style.width = '28px';
    fallback.style.height = '10px';
    fallback.style.background = 'radial-gradient(#9aa0a6 3px, transparent 4px) 0 50%/10px 10px repeat-x';

    const useFallback = () => { vid.style.display='none'; fallback.style.display='inline-block'; };
    vid.addEventListener('error', useFallback);
    vid.addEventListener('stalled', useFallback);
    vid.addEventListener('abort', useFallback);

    el.appendChild(vid);
    el.appendChild(fallback);

    chat.insertBefore(el, chat.querySelector('.anchor'));
    scrollToBottomSafe();
    endScrollBatch(chat);
    return el;
  }

  /* ====== –±—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã (–î–∞/–ù–µ—Ç) ====== */
  function collapseOldQuickReplies(){
    const qrs = [...chat.querySelectorAll('.msg.ai .qr')];
    qrs.forEach(qr => {
      qr.querySelectorAll('button').forEach(b => b.disabled = true);
      qr.style.display = 'none';
    });
  }
  function removeAllQuickReplyButtons(){
    chat.querySelectorAll('.msg.ai .qr').forEach(qr => qr.remove());
  }

  function addQuickReplies(text, options, {replaceNode=null} = {}){
    collapseOldQuickReplies();

    const wrap = document.createElement('div');
    wrap.className = 'msg ai m20';
    wrap.innerHTML = `
      <div class="bubble">${text}</div>
      <div class="qr"></div>
    `;
    const qr = wrap.querySelector('.qr');

    options.forEach(opt => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = opt.label;
      btn.classList.add('s10');
      if (opt.variant) btn.classList.add(opt.variant);

      btn.addEventListener('click', () => {
        if (qr) qr.remove();
        const userBubble = addMessage('user', opt.label);
        scrollToNode(userBubble);
        muteComposer();
        opt.onClick?.(opt.value, wrap);
      });

      qr.appendChild(btn);
    });

    if (replaceNode) replaceNode.replaceWith(wrap);
    else chat.insertBefore(wrap, chat.querySelector('.anchor'));

    scrollToBottomSafe();
    return wrap;
  }

  /* ====== ¬´–¥—É–º–∞—é¬ª —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π ====== */
  function randDelay(min=3900, max=3900){
    return Math.round(min + Math.random()*(max-min));
  }
  async function aiQuickRepliesWithThinking(text, options){
    setBusy(true);
    const typing = showThinking();
    await new Promise(r => setTimeout(r, randDelay()));
    const res = addQuickReplies(text, options, {replaceNode: typing});
    setBusy(false);
    return res;
  }

  /* =========================
     –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
  ========================== */
  function normalize(s){
    return (s || '')
      .toLowerCase()
      .replace(/[.,!?()"¬´¬ª'`]/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();
  }

  const PROFANITY = [
    /–ø—Ä–∏–¥—É—Ä–æ–∫/, /–¥—É—Ä–∞–∫/, /–¥—É—Ä[a–æ]—á?–æ–∫/, /—É—Ä–æ–¥/, /–∏–¥–∏–æ—Ç/, /—Ç—É–ø–∏—Ü[–∞—ã]/,
    /–∫—Ä–µ—Ç–∏–Ω/, /–¥–µ?–±–∏–ª/, /–±–∞–ª–±–µ—Å/, /–∂–æ–ø–∞/, /—Å—É—á–∞—Ä–∞/, /–æ–ª–µ–Ω—å/
  ];
  const containsProfanity = (text) => PROFANITY.some(rx => rx.test(text));

  function interpretYesNo(raw){
    const t = normalize(raw);
    const tokens = t.split(' ');
    const has = (...w) => w.some(x => tokens.includes(x));
    const isYes = has('–¥–∞','–∞–≥–∞','—É–≥—É','–∫–æ–Ω–µ—á–Ω–æ','–æ–∫','–æ–∫–µ–π','–≥–æ','–ø–æ–≥–Ω–∞–ª–∏','–¥–∞–≤–∞–π','–π–µ—Å','yes','y')
      || /^[\+\üëç‚úÖüëå]+$/.test(t) || /^–¥–∞$/.test(t) || /^–¥–∞+$/.test(t);
    const isNo  = has('–Ω–µ—Ç','–Ω–µ','–Ω–µ–∞','–ø–æ—Ç–æ–º','no','nope','–Ω–æ—É–ø','n','–Ω–µ—Ö–æ—á—É','–Ω–µ–Ω–∞–¥–æ')
      || /^[\-\üëé‚ùå]+$/.test(t) || /^–Ω–µ—Ç$/.test(t);
    if (isYes) return 'yes';
    if (isNo)  return 'no';
    return null;
  }

  function isIphoneIntent(raw){
    const t = normalize(raw);
    return /–∞–π—Ñ–æ–Ω\w*/.test(t) || /\b–∞–π—Ñ\b/.test(t) || /\biphone\b/.test(t) || /\bi[\s-]*phone\b/.test(t) || /\biphon\w*\b/.test(t);
  }
  function isAndroidIntent(raw){
    const t = normalize(raw);
    return /–∞–Ω–¥—Ä–æ–∏–¥\w*/.test(t) || /\bandroid\b/.test(t) || /\b–∞–Ω–¥—Ä\b/.test(t) || /–Ω–∞\s+–∞–Ω–¥—Ä–æ–∏–¥(–µ|–∞—Ö)?/.test(t) || /(—Ö–æ—á—É|–Ω–∞–π–¥–∏|–≤—ã–±–µ—Ä–∏|–ø–æ—Å–æ–≤–µ—Ç—É–π).*(–∞–Ω–¥—Ä–æ(–∏–¥|–∏–¥–Ω—ã–π)|android)/.test(t);
  }
  function hasGreeting(raw){
    const t = normalize(raw);
    const tokens = t.split(' ');
    const greetSet = new Set(['–ø—Ä–∏–≤–µ—Ç','–ø—Ä–∏–≤','–∑–¥—Ä–∞–≤','–∑–¥—Ä–∞—Å—Ç–µ','–∑–¥—Ä–∞—Å—å—Ç–µ','—Ö–∞–π','–π–æ','–π–æ—É','—Ö—ç–ª–ª–æ—É','—Ö–µ–ª–ª–æ—É','—Ö–µ–ª–æ—É','—Ö—ç–ª–æ—É','hello','hi','hey']);
    return tokens.some(w => greetSet.has(w));
  }

  /* =========================
     FSM + –æ—Ç–≤–µ—Ç—ã
  ========================== */
  const STATE = { IDLE: 'idle', ASK_SEARCH: 'ask_search', CONFIRM_AGAIN: 'confirm_again' };
  let state = STATE.IDLE;

  async function showAnswer(){
    await window.AssistCards.aiCardsFromJSONWithThinking({
      setBusy, showThinking, scrollToNode, randDelay, addMessage, FALLBACK_TXT,
      CARDS_CSS_URL, ANSWER_DATA_URL, HEART_OFF, HEART_ON
    });
    state = STATE.IDLE;
  }

  function askSearchFirst(){
    state = STATE.ASK_SEARCH;
    aiQuickRepliesWithThinking(
      '–í–æ–æ–±—â–µ-—Ç–æ, —É–∂–µ\u00A0–∑–¥–æ—Ä–æ–≤–∞–ª–∏—Å—å, —Ö–æ—á–µ—à—å –ø–æ–∏—Å–∫–∞—Ç—å –∞–π—Ñ–æ–Ω?',
      [
        { label: '–î–∞, –¥–∞–≤–∞–π',    value: 'yes', onClick: () => showAnswer() },
        { label: '–ù–µ—Ç, –Ω–µ —Ö–æ—á—É', value: 'no',  onClick: () => askSearchAgain() },
      ]
    );
  }
  function askSearchAgain(){
    state = STATE.CONFIRM_AGAIN;
    aiQuickRepliesWithThinking(
      '–†–∞–∑–≤–µ –º–æ–π –≤–µ–ª–∏–∫–∏–π —Å–æ–∑–¥–∞—Ç–µ–ª—å, –ø—Ä–æ—Ä–æ–∫, –ø—Ä–æ–≤–∏–¥–µ—Ü, –ª—É—á—à–∏–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –∫–æ–º–ø–∞–Ω–∏–∏, —á–µ–ª–æ–≤–µ–∫ –≥–æ–¥–∞ –ø–æ\u00A0–≤–µ—Ä—Å–∏–∏ —Å–∞–º–æ–≥–æ —Å–µ–±—è –Ω–µ\u00A0—Å–∫–∞–∑–∞–ª —Ç–µ–±–µ, —á—Ç–æ\u00A0—è\u00A0–∏—â—É —Ç–æ–ª—å–∫–æ –∞–π—Ñ–æ–Ω—ã? –•–æ—á–µ—à—å –ø–æ–∏—â–µ–º –≤–º–µ—Å—Ç–µ?',
      [
        { label: '–î–∞, –¥–∞–≤–∞–π',    value: 'yes', onClick: () => showAnswer() },
        { label: '–ù–µ—Ç, –Ω–µ —Ö–æ—á—É', value: 'no',  onClick: () => askSearchAgain() },
      ]
    );
  }
  function dontUnderstand(){
    state = STATE.ASK_SEARCH;
    aiQuickRepliesWithThinking(
      '–Ø –Ω–µ –æ—á–µ–Ω—å –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ\u00A0—Ç—ã\u00A0–æ—Ç\u00A0–º–µ–Ω—è —Ö–æ—á–µ—à—å, –Ω–æ\u00A0—Ä–∏—Å–∫–Ω—É –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç—å, —á—Ç–æ\u00A0—Ç–µ–±–µ –Ω—É–∂–µ–Ω –∞–π—Ñ–æ–Ω. –ü–æ–∏—â–µ–º?',
      [
        { label: '–î–∞, –¥–∞–≤–∞–π',    value: 'yes', onClick: () => showAnswer() },
        { label: '–ù–µ—Ç, –Ω–µ —Ö–æ—á—É', value: 'no',  onClick: () => askSearchAgain() },
      ]
    );
  }
  function respondToProfanity(){
    state = STATE.ASK_SEARCH;
    aiQuickRepliesWithThinking(
      '–ö—Ç–æ –±—ã –≥–æ–≤–æ—Ä–∏–ª, –º–Ω–µ –ê–Ω—Ç–æ–Ω —Ç–∞–∫–æ–µ –ø—Ä–æ —Ç–µ–±—è —Ä–∞—Å—Å–∫–∞–∑–∞–ª, —è\u00A0—Ç—Ä–∏ –¥–Ω—è –Ω–µ\u00A0—Å–ø–∞–ª, –Ω–µ\u00A0–µ–ª. –ù–æ\u00A0—Ä—É–≥–∞—Ç—å—Å—è –Ω–µ\u00A0—Ö–æ—á—É, –¥–∞–≤–∞–π –ª—É—á—à–µ –ø–æ–∏—â–µ–º –∞–π—Ñ–æ–Ω?',
      [
        { label: '–î–∞, –¥–∞–≤–∞–π',    value: 'yes', onClick: () => showAnswer() },
        { label: '–ù–µ—Ç, –Ω–µ —Ö–æ—á—É', value: 'no',  onClick: () => askSearchAgain() },
      ]
    );
  }
  function respondToAndroid(){
    state = STATE.ASK_SEARCH;
    aiQuickRepliesWithThinking(
      '–¢–æ–ª—å–∫–æ –ø—Ä–µ–¥—Å—Ç–∞–≤—å, –∫–∞–∫–∞—è –∞–Ω–¥—Ä–æ–∏–¥ ‚Äî –ø–æ–º–æ–π–∫–∞, —á—Ç–æ\u00A0–º–æ–π –≤–µ–ª–∏–∫–∏–π —Å–æ–∑–¥–∞—Ç–µ–ª—å –Ω–µ\u00A0–ø–æ–ª–µ–Ω–∏–ª—Å—è –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Å–∫—Ä–∏–ø—Ç, —á—Ç–æ–±—ã —Ç—ã\u00A0—É–≤–∏–¥–µ–ª –≠–¢–û\u00A0—Å–æ–æ–±—â–µ–Ω–∏–µ. –î–∞–≤–∞–π –ª—É—á—à–µ –ø–æ–∏—â–µ–º –∞–π—Ñ–æ–Ω?',
      [
        { label: '–î–∞, –¥–∞–≤–∞–π',    value: 'yes', onClick: () => showAnswer() },
        { label: '–ù–µ—Ç, –Ω–µ —Ö–æ—á—É', value: 'no',  onClick: () => askSearchAgain(), variant: 'secondary' },
      ]
    );
  }

  /* =========================
     –†–æ—É—Ç–µ—Ä —Ç–µ–∫—Å—Ç–∞
  ========================== */
  function routeText(raw){
    const text = (raw || '').trim();
    if (!text) return;

    removeAllQuickReplyButtons();

    if (isIphoneIntent(text)) return showAnswer();
    if (isAndroidIntent(text)) return respondToAndroid();

    const norm = normalize(text);
    if (containsProfanity(norm)) return respondToProfanity();
    if (hasGreeting(norm)) return askSearchFirst();

    const yn = interpretYesNo(norm);
    if (yn) return yn === 'yes' ? showAnswer() : askSearchAgain();

    return dontUnderstand();
  }

  /* =========================
     –û—Ç–ø—Ä–∞–≤–∫–∞
  ========================== */
  function handleSend(raw){
    if (isBusy) return;
    const text = (raw || '').trim();
    if (!text) return;

    removeAllQuickReplyButtons();

    beginScrollBatch(chat);
    const u = addMessage('user', text);
    endScrollBatch(chat);

    ta.value = '';
    autosize();
    muteComposer();

    // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —É–π–¥—ë—Ç –ø–æ–¥ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    syncComposerOffset();
    scrollToBottomSafe();

    routeText(text);
  }

  send.addEventListener('click', () => {
    if (isBusy) return;
    handleSend(ta.value);
  });

  ta.addEventListener('keydown', (e) => {
    if (isBusy && e.key === 'Enter'){
      e.preventDefault();
      return;
    }
    if (e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      handleSend(ta.value);
    }
  });
})();
</script>

<!-- –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ –∫–Ω–æ–ø–∫–µ + -->
<script>
(() => {
  const btn = document.querySelector('.new-chat-btn');
  if (!btn) return;

  const reload = (e) => {
    e.preventDefault();
    e.stopPropagation();
    window.location.reload();
  };

  btn.addEventListener('click', reload);
  btn.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') reload(e);
  });
})();
</script>

</body>
</html>
